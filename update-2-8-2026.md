**Update — 2026-02-08**

This document summarizes all code, database, API and UI changes implemented during the conversation and development session that led up to this update.

**Summary**
- **Feature:** Add schedule management (Admin/Dean) and student schedule selection flow.
- **Scope:** Backend DB schema + API endpoints, frontend services, admin/dean UI, student dashboard schedule selection and display, runtime migrations and defensive handling, debug endpoints.

**Backend — Database & Migrations**
- **New table:** `subject_schedules` (columns: `id`, `subject_id`, `day_time`, `room`, `instructor`, `capacity`, `is_active`, timestamps). Created in `src/backend-setup/src/database/setup.ts`.
- **Enrollment migration:** Added `schedule_id` column to `enrollment_subjects` (code attempts runtime PRAGMA + ALTER TABLE if missing).
- **Defensive migrations:** Controllers attempt to create missing tables/columns when encountering "no such table/column" errors to avoid 500s on older DBs.

**Backend — API Endpoints & Controllers**
- `GET /api/maintenance/schedules` — debug listing of all `subject_schedules` (maintenance controller).
- Maintenance schedule CRUD: create / update / delete schedules for a subject (maintenance controller & routes).
- `GET /api/subjects/:id/schedules` — return schedules for a subject (subject controller).
- `GET /api/enrollments/:id` — `getEnrollmentDetails` updated to LEFT JOIN `subject_schedules` via `enrollment_subjects.schedule_id`, and *attach `schedule_options`* (available schedules per subject) to each enrolled subject in the response (enrollment controller).
- `POST /api/enrollments/:id/subjects` — `addSubjectToEnrollment` now accepts `schedule_id` and persists it to `enrollment_subjects`; if `schedule_id` is provided, controller resolves day_time and stores `schedule` text as well.
- `GET /api/students/enrollment-subjects/debug` — debug endpoint returning enrollment_subjects joined with subject_schedules for inspection (student controller).

**Backend — Error handling & robustness**
- Converted unsafe error property access to TypeScript-safe extraction (avoid runtime TS compile errors). 
- Added try/catch fallbacks around schedule queries so missing tables return empty arrays instead of errors.

**Frontend — Services**
- `src/services/maintenance.service.ts`: added functions for create/get/update/delete schedules.
- `src/services/subject.service.ts`: added `getSchedules(subjectId)` to fetch schedules for a subject.
- `src/services/enrollment.service.ts`: extended `addSubject` to accept `schedule_id` and pass it to the backend.

**Frontend — Admin / Dean UI**
- `src/components/SubjectsManagement.tsx`: added schedule management modal and CRUD controls for schedules (create/edit/delete schedules for a subject).

**Frontend — Student UI**
- `src/components/StudentDashboard.tsx`:
  - When adding a subject, the student flow now fetches available schedules for that subject. If schedules exist, a schedule-selection modal is shown; if none exist, the subject is added directly.
  - Student `addSubject` sends `schedule_id` to backend when adding with a selected schedule.
  - `getEnrollmentDetails` response is mapped so each enrolled subject includes `scheduleOptions` and the UI prefers: `enrollment_subject.schedule` → joined schedule from `subject_schedules` → first available `scheduleOptions` entry.
  - Display logic in the "My Class Schedule" card groups courses by day & time and uses the fallback described above (so enrolled subjects without an explicit assigned schedule will show the first available schedule option if present).

**Frontend — Minor**
- Small robustness fixes in the Student Dashboard (safe property access, fallbacks for missing data). 

**Debugging & Observations**
- Added debug endpoints to inspect the DB state. Example observations from debugging:
  - `subject_schedules` contained schedule rows (e.g., `Mon 1-2` for `subject_id = 1`).
  - `enrollment_subjects` rows for the student had `schedule_id: null` (no assigned schedule), which is why the UI previously showed "No schedule available".
- Patched StudentDashboard mapping so it displays the first schedule option when `schedule_id` is null.

**Files Touched (high level)**
- Backend:
  - `src/backend-setup/src/database/setup.ts`
  - `src/backend-setup/src/controllers/maintenance.controller.ts`
  - `src/backend-setup/src/controllers/subject.controller.ts`
  - `src/backend-setup/src/controllers/enrollment.controller.ts`
  - `src/backend-setup/src/controllers/student.controller.ts`
  - `src/backend-setup/src/routes/*` (maintenance, subject, student)
- Frontend:
  - `src/components/StudentDashboard.tsx`
  - `src/components/SubjectsManagement.tsx`
  - `src/services/enrollment.service.ts`
  - `src/services/subject.service.ts`
  - `src/services/maintenance.service.ts`

**How to verify (quick steps)**
1. Restart the backend server so migrations and controller changes load.  
2. Restart the frontend dev server.  
3. As Admin/Dean: open `SubjectsManagement` → create a schedule for a subject.  
4. As Student: open dashboard → add the subject. If schedules exist you should see the schedule selection modal; after adding the subject the student's "My Class Schedule" should show the assigned schedule or the first available schedule option.
5. Use debug endpoints to inspect data if needed:
   - `GET /api/maintenance/schedules` — lists schedules
   - `GET /api/enrollments/:id` — verify `subjects[*].schedule_options` is present and `subjects[*].schedule_id` when assigned
   - `GET /api/students/enrollment-subjects/debug` — inspect enrollment_subjects joined with schedules

**Remaining / Suggested Next Work**
- Add automated tests for schedule flow (end-to-end or API + UI unit tests).  
- Decide and implement a policy for auto-assigning a default schedule to existing `enrollment_subjects` rows that have null `schedule_id` (if desired).  
- Add documentation page describing how admins/deans create schedules and how students select them (task pending: "Document how to add schedules for students").

If you want, I can now:
- run the server restart steps and smoke-test the student flow locally, or
- create a short PR that auto-assigns the first active schedule for enrolled subjects with null `schedule_id` (opt-in behavior).

-- End of update
